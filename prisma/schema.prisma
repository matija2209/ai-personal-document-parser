generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id          String   @id @default(cuid())
  clerkId     String   @unique
  email       String   @unique
  name        String?
  imageUrl    String?
  preferences Json?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  // Relations
  documents     Document[]
  documentFiles DocumentFile[]
  
  @@map("users")
}

model Document {
  id            String    @id @default(cuid())
  userId        String
  documentType  String    // "driving_license", "passport", etc.
  status        String    @default("processing") // "processing", "completed", "failed"
  retentionDays Int?      // null = keep forever, number = days to keep
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
  deletedAt     DateTime? // soft delete for retention logic
  
  // Relations
  user          User            @relation(fields: [userId], references: [clerkId], onDelete: Cascade)
  files         DocumentFile[]
  extractions   Extraction[]
  errors        ProcessingError[]
  
  @@index([userId])
  @@index([createdAt])
  @@index([status])
  @@index([retentionDays])
  @@map("documents")
}

model DocumentFile {
  id               String   @id @default(cuid())
  documentId       String
  userId           String
  fileKey          String   @unique
  filePath         String
  fileType         String   // "front", "back"
  originalFileName String
  compressedSize   Int
  originalSize     Int
  mimeType         String
  uploadedAt       DateTime @default(now())
  
  // Relations
  document         Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  user             User     @relation(fields: [userId], references: [clerkId], onDelete: Cascade)
  
  @@index([documentId])
  @@index([userId])
  @@index([uploadedAt])
  @@map("document_files")
}

model Extraction {
  id                   String   @id @default(cuid())
  documentId           String
  modelName            String   // "gemini-flash", "gpt-4o-mini", etc.
  extractionData       Json     // the actual extracted fields
  fieldsForReview      Json?    // array of field names that need review
  confidenceScore      Float?
  processingTimeMs     Int?
  isManuallyCorrected  Boolean  @default(false)
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt
  
  // Relations
  document             Document @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  @@index([documentId])
  @@map("extractions")
}

model ProcessingError {
  id           String    @id @default(cuid())
  documentId   String?
  errorType    String    // "image_upload", "ai_processing", "validation", etc.
  errorMessage String
  errorDetails Json?
  stepFailed   String
  retryCount   Int       @default(0)
  resolved     Boolean   @default(false)
  createdAt    DateTime  @default(now())
  
  // Relations
  document     Document? @relation(fields: [documentId], references: [id], onDelete: Cascade)
  
  @@index([documentId])
  @@index([resolved])
  @@map("processing_errors")
}
